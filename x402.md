# x402 Payment Rails Setup (Eden Haus)

This document explains how the x402 payment flow is wired in this repo and what you need to configure to make it work end-to-end.

## Architecture Overview

Flow:
1. User clicks "Buy" on the prediction market page.
2. Frontend calls `POST /api/x402/place-bet` (Next.js route).
3. Next.js proxies to backend `POST /api/v1/x402/place-bet`.
4. Backend replies `402 Payment Required` with:
   - `Payment-Required` header containing payee address + amount.
   - `X-Quote-ID` header for confirmation.
5. Frontend wallet sends the payment transaction.
6. Frontend calls `POST /api/x402/confirm` with `quote_id`.
7. Next.js proxies to backend `POST /api/v1/bets/confirm`.

## Key Files

Frontend:
- `apps/frontend/app/prediction/[id]/page.tsx` (payment trigger on Buy)
- `apps/frontend/lib/x402.ts` (402 handling + wallet payment + confirm)
- `apps/frontend/app/api/x402/place-bet/route.ts` (proxy to backend x402)
- `apps/frontend/app/api/x402/confirm/route.ts` (proxy to backend confirm)

Backend:
- `apps/backend/app/api/v1/x402.py` (quote + 402 response)
- `apps/backend/app/api/v1/bets.py` (confirm after payment)
- `apps/backend/app/core/x402.py` (payment verification)
- `apps/backend/app/core/contracts.py` (contract RPC)

## Required Environment Variables

Backend (Railway / local):
- `CRONOS_RPC_URL` (Cronos RPC endpoint)
- `MARKET_MANAGER_ADDRESS` (contract or treasury address)
- `X402_PAYEE_ADDRESS` (optional; overrides payee in 402 header)

Frontend (Vercel / local):
- `NEXT_PUBLIC_API_URL` (base URL for backend, e.g. `https://your-backend.railway.app`)
- `API_BASE_URL` (optional; if set on server, takes precedence for proxy routes)

WalletConnect:
- `NEXT_PUBLIC_WALLETCONNECT_PROJECT_ID`
- `NEXT_PUBLIC_ENABLE_TESTNETS` (optional)

## Payment-Required Header Format

Backend returns:
- `Payment-Required: crypto-cronos://<payee_address>@<amount>`
- `X-Quote-ID: <quote_id>`

Frontend parses the address + amount and sends a wallet transaction for the exact amount.

## Local Setup (Fast Check)

1) Backend
- Ensure `apps/backend` runs and `/api/v1/x402/place-bet` returns 402.
- Set `X402_PAYEE_ADDRESS` or confirm `MARKET_MANAGER_ADDRESS` is correct.

2) Frontend
- Set `NEXT_PUBLIC_API_URL` to the backend URL.
- Run the frontend and open `/prediction/[id]`.
- Connect wallet and place a test bet.

## Testing Tips

- Backend x402 should respond `402` for quote requests.
- `Payment-Required` header must contain a valid Cronos address.
- If wallet transactions fail, confirm:
  - User is on the correct network.
  - Amount is valid and non-zero.
  - Address passes `isAddress` checks in `apps/frontend/lib/x402.ts`.

## Notes / Known Constraints

- `apps/backend/app/core/x402.py` currently simulates payment verification.
- `apps/backend/app/core/contracts.py` uses direct JSON-RPC and is stubbed for real signing.
- This flow assumes a native CRO payment (parseEther). If switching to USDT, the payment step must be replaced with ERC20 transfer logic.
